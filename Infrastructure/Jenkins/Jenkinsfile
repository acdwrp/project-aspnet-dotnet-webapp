pipeline {
  agent {
    node {
      label 'win'&&'slave'
      customWorkspace "workspace\\${JOB_NAME.replace("%2F", "_")}"
    }

  }
  stages {
    stage('Build') { 
      steps {

        buildDotNet()

      }
    }
    stage('Test') {
      steps {
        testDotNet()
      }
    }
    stage('Package Artifacts') {
      steps {

        archivePackage()

      }
    }
    stage('Push to artifact storage') {
      when {
        branch 'master'
      }
      steps {

        deployToS3()

      }
    }
    stage('Deploy to Test')
    {
        steps{
          pushToEnvironment()
        }
    }
    stage('Run smoke tests'){
        steps{
          smokeTestEnvironment()
        }
    }
    stage('Run API tests'){
      steps{
        apiTestEnvironment()
      }
    }
    stage('Run stress tests'){
      steps{
        stressTestEnvironment()
      }
    }
  }
  environment {
    WorkspaceName = JOB_NAME.replace("%2F", "_")
    ConfigLocation = "Infrastructure/Jenkins/DeploymentConfig.json"
  }
  options {
    buildDiscarder(logRotator(numToKeepStr: '10', artifactNumToKeepStr: '10'))
    timeout(time: 20, unit: 'MINUTES')
  }
}